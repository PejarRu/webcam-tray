#!/bin/bash

# VirtualCam Tray - System tray icon for controlling VirtualCam service
# Supports event-based updates, logging, and configuration

SERVICE_NAME="virtualcam.service"
ICON="camera-web"

# Use XDG spec for runtime files
RUNTIME_DIR="${XDG_RUNTIME_DIR:-/tmp}"
PIPE="$RUNTIME_DIR/webcam-tray-pipe"
PID_FILE="$RUNTIME_DIR/webcam-tray.pid"

# Configuration
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/webcam-tray"
CONFIG_FILE="$CONFIG_DIR/config"

# Logging
LOG_TAG="webcam-tray"
LOG_FORMAT="${LOG_FORMAT:-text}"  # text or json

# Source configuration if exists
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
fi

# Log helper - structured logging
log_json() {
    local level="$1"
    local message="$2"
    local extra="${3:-}"
    
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    local hostname=$(hostname)
    
    if [ -n "$extra" ]; then
        printf '{"timestamp":"%s","level":"%s","hostname":"%s","service":"webcam-tray","msg":"%s",%s}\n' \
            "$timestamp" "$level" "$hostname" "$message" "$extra"
    else
        printf '{"timestamp":"%s","level":"%s","hostname":"%s","service":"webcam-tray","msg":"%s"}\n' \
            "$timestamp" "$level" "$hostname" "$message"
    fi
}

# Log helper
log_info() {
    if [ "$LOG_FORMAT" = "json" ]; then
        log_json "info" "$1" | logger -t "$LOG_TAG" -p user.info
        echo "$(log_json "info" "$1")"
    else
        logger -t "$LOG_TAG" -p user.info "$1"
        echo "[INFO] $1"
    fi
}

log_error() {
    if [ "$LOG_FORMAT" = "json" ]; then
        log_json "error" "$1" | logger -t "$LOG_TAG" -p user.err
        echo "$(log_json "error" "$1")" >&2
    else
        logger -t "$LOG_TAG" -p user.err "$1"
        echo "[ERROR] $1" >&2
    fi
}

log_event() {
    local event_type="$1"
    local message="$2"
    local extra="$3"
    
    if [ "$LOG_FORMAT" = "json" ]; then
        log_json "event" "$message" "\"event_type\":\"$event_type\",$extra" | logger -t "$LOG_TAG" -p user.info
    else
        logger -t "$LOG_TAG" -p user.info "[$event_type] $message"
    fi
}

# Kill previous instances with PID validation
kill_previous() {
    if [ -f "$PID_FILE" ]; then
        OLD_PID=$(cat "$PID_FILE")
        if [ -n "$OLD_PID" ] && kill -0 "$OLD_PID" 2>/dev/null; then
            # Verify it's actually our process
            if ps -p "$OLD_PID" -o comm= 2>/dev/null | grep -q "yad"; then
                log_info "Killing previous instance (PID: $OLD_PID)"
                kill "$OLD_PID" 2>/dev/null
                sleep 0.5
            else
                log_info "PID $OLD_PID is not yad, ignoring"
            fi
        fi
        rm -f "$PID_FILE"
    fi
}

get_status() {
    systemctl --user is-active "$SERVICE_NAME" 2>/dev/null
}

start_service() {
    log_event "service_control" "Starting VirtualCam service" "\"action\":\"start\""
    systemctl --user start "$SERVICE_NAME"
    notify-send "VirtualCam" "Servicio iniciado ✓" -i "$ICON"
}

stop_service() {
    log_event "service_control" "Stopping VirtualCam service" "\"action\":\"stop\""
    systemctl --user stop "$SERVICE_NAME"
    notify-send "VirtualCam" "Servicio detenido ✗" -i "$ICON"
}

toggle_service() {
    status=$(get_status)
    if [ "$status" = "active" ]; then
        log_event "service_control" "Toggling service to stop" "\"action\":\"toggle\",\"from\":\"active\""
        stop_service
    else
        log_event "service_control" "Toggling service to start" "\"action\":\"toggle\",\"from\":\"inactive\""
        start_service
    fi
}

show_status() {
    status=$(get_status)
    if [ "$status" = "active" ]; then
        notify-send "VirtualCam" "Estado: Activo ✓" -i "$ICON"
    else
        notify-send "VirtualCam" "Estado: Inactivo ✗" -i "$ICON"
    fi
}

show_logs() {
    log_info "Opening logs viewer"
    journalctl --user -u "$SERVICE_NAME" -n 100 --no-pager | zenity --text-info --title="VirtualCam Logs" --width=900 --height=600 &
}

show_config() {
    if [ ! -f "$CONFIG_FILE" ]; then
        mkdir -p "$CONFIG_DIR"
        cat > "$CONFIG_FILE" <<EOF
# VirtualCam Tray Configuration
# Update interval in seconds (0 = event-based, not yet implemented)
UPDATE_INTERVAL=2

# Service name
SERVICE_NAME="virtualcam.service"

# Icon name (from icon theme)
ICON="camera-web"

# Log format: text or json
LOG_FORMAT=text

# Autostart on login
AUTOSTART=false
EOF
    fi
    
    if command -v xdg-open &> /dev/null; then
        xdg-open "$CONFIG_FILE" &
    else
        zenity --info --text="Config file: $CONFIG_FILE" --width=400
    fi
}

enable_autostart() {
    AUTOSTART_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/autostart"
    AUTOSTART_FILE="$AUTOSTART_DIR/webcam-tray.desktop"
    
    mkdir -p "$AUTOSTART_DIR"
    
    # Get the full path to webcam-tray
    WEBCAM_TRAY_PATH=$(command -v webcam-tray || echo "$HOME/.local/bin/webcam-tray")
    
    cat > "$AUTOSTART_FILE" <<EOF
[Desktop Entry]
Type=Application
Name=VirtualCam Tray
Comment=Control del servicio de cámara virtual
Exec=$WEBCAM_TRAY_PATH
Icon=camera-web
Terminal=false
Categories=Utility;System;
StartupNotify=false
X-GNOME-Autostart-enabled=true
Hidden=false
EOF
    
    log_event "autostart" "Autostart enabled" "\"path\":\"$AUTOSTART_FILE\""
    notify-send "VirtualCam Tray" "Autostart habilitado ✓" -i "$ICON"
}

disable_autostart() {
    AUTOSTART_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/autostart/webcam-tray.desktop"
    
    if [ -f "$AUTOSTART_FILE" ]; then
        rm -f "$AUTOSTART_FILE"
        log_event "autostart" "Autostart disabled" "\"path\":\"$AUTOSTART_FILE\""
        notify-send "VirtualCam Tray" "Autostart deshabilitado ✗" -i "$ICON"
    else
        notify-send "VirtualCam Tray" "Autostart ya estaba deshabilitado" -i "$ICON"
    fi
}

check_autostart() {
    AUTOSTART_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/autostart/webcam-tray.desktop"
    
    if [ -f "$AUTOSTART_FILE" ]; then
        notify-send "VirtualCam Tray" "Autostart: Habilitado ✓" -i "$ICON"
    else
        notify-send "VirtualCam Tray" "Autostart: Deshabilitado ✗" -i "$ICON"
    fi
}

update_icon() {
    if [ ! -p "$PIPE" ]; then
        return
    fi
    
    status=$(get_status)
    if [ "$status" = "active" ]; then
        echo "tooltip:VirtualCam: ✓ Activo" > "$PIPE"
        # Optional: Change icon color (requires themed icons)
        # echo "icon:camera-web-active" > "$PIPE"
    else
        echo "tooltip:VirtualCam: ✗ Inactivo" > "$PIPE"
        # echo "icon:camera-web-symbolic" > "$PIPE"
    fi
}

tray_menu() {
    # Cleanup previous files
    rm -f "$PIPE"
    mkfifo "$PIPE"
    
    # Save PID
    echo $$ > "$PID_FILE"
    
    # Cleanup on exit
    trap "rm -f $PIPE $PID_FILE; exit" EXIT INT TERM
    
    log_info "Starting tray icon"
    
    # Start yad in background
    yad --notification \
        --listen \
        --image="$ICON" \
        --text="VirtualCam" \
        --menu="Iniciar!$0 cmd_start|Detener!$0 cmd_stop|Toggle!$0 cmd_toggle|Estado!$0 cmd_status|Ver Logs!$0 cmd_logs|Configuración!$0 cmd_config|Autostart!bash -c 'AUTOSTART_SUBMENU'|Salir!$0 cmd_quit" \
        --no-middle \
        --command="" < "$PIPE" &
    
    # Replace autostart submenu placeholder after yad starts
    sleep 0.5
    if [ -f "${XDG_CONFIG_HOME:-$HOME/.config}/autostart/webcam-tray.desktop" ]; then
        # Autostart enabled, show disable option
        pkill -f "yad.*VirtualCam" 2>/dev/null || true
        yad --notification \
            --listen \
            --image="$ICON" \
            --text="VirtualCam" \
            --menu="Iniciar!$0 cmd_start|Detener!$0 cmd_stop|Toggle!$0 cmd_toggle|Estado!$0 cmd_status|Ver Logs!$0 cmd_logs|Configuración!$0 cmd_config|Autostart:Habilitar!$0 cmd_autostart_enable:Deshabilitar!$0 cmd_autostart_disable:Estado!$0 cmd_autostart_status|Salir!$0 cmd_quit" \
            --no-middle \
            --command="" < "$PIPE" &
    else
        # Autostart disabled, show enable option
        pkill -f "yad.*VirtualCam" 2>/dev/null || true
        yad --notification \
            --listen \
            --image="$ICON" \
            --text="VirtualCam" \
            --menu="Iniciar!$0 cmd_start|Detener!$0 cmd_stop|Toggle!$0 cmd_toggle|Estado!$0 cmd_status|Ver Logs!$0 cmd_logs|Configuración!$0 cmd_config|Autostart:Habilitar!$0 cmd_autostart_enable:Deshabilitar!$0 cmd_autostart_disable:Estado!$0 cmd_autostart_status|Salir!$0 cmd_quit" \
            --no-middle \
            --command="" < "$PIPE" &
    fi
    
    YAD_PID=$!
    log_info "Yad started with PID: $YAD_PID"
    
    # Update interval from config (default 2 seconds)
    INTERVAL="${UPDATE_INTERVAL:-2}"
    
    # Update loop
    while true; do
        if ! kill -0 "$YAD_PID" 2>/dev/null; then
            log_info "Yad process terminated, exiting"
            break
        fi
        update_icon
        sleep "$INTERVAL"
    done
    
    rm -f "$PIPE" "$PID_FILE"
}

# Command handlers
case "${1:-tray}" in
    start)
        start_service
        ;;
    stop)
        stop_service
        ;;
    toggle)
        toggle_service
        ;;
    status)
        show_status
        ;;
    logs)
        show_logs
        ;;
    config)
        show_config
        ;;
    autostart-enable)
        enable_autostart
        ;;
    autostart-disable)
        disable_autostart
        ;;
    autostart-status)
        check_autostart
        ;;
    tray)
        kill_previous
        tray_menu
        ;;
    cmd_start)
        start_service
        ;;
    cmd_stop)
        stop_service
        ;;
    cmd_toggle)
        toggle_service
        ;;
    cmd_status)
        show_status
        ;;
    cmd_logs)
        show_logs
        ;;
    cmd_config)
        show_config
        ;;
    cmd_autostart_enable)
        enable_autostart
        ;;
    cmd_autostart_disable)
        disable_autostart
        ;;
    cmd_autostart_status)
        check_autostart
        ;;
    cmd_quit)
        if [ -f "$PID_FILE" ]; then
            TRAY_PID=$(cat "$PID_FILE")
            if [ -n "$TRAY_PID" ] && kill -0 "$TRAY_PID" 2>/dev/null; then
                log_info "Exiting tray (PID: $TRAY_PID)"
                kill "$TRAY_PID" 2>/dev/null
            fi
        fi
        rm -f "$PIPE" "$PID_FILE"
        exit 0
        ;;
    --help|-h)
        echo "VirtualCam Tray - Control del servicio de cámara virtual"
        echo ""
        echo "Uso: $0 [comando]"
        echo ""
        echo "Comandos:"
        echo "  tray     - Iniciar icono de bandeja (default)"
        echo "  start    - Iniciar servicio"
        echo "  stop     - Detener servicio"
        echo "  toggle           - Alternar estado del servicio"
        echo "  status           - Mostrar estado"
        echo "  logs             - Ver logs"
        echo "  config           - Abrir configuración"
        echo "  autostart-enable - Habilitar autostart en login"
        echo "  autostart-disable- Deshabilitar autostart"
        echo "  autostart-status - Ver estado de autostart"
        echo ""
        echo "Archivos:"
        echo "  Config:   $CONFIG_FILE"
        echo "  Autostart:${XDG_CONFIG_HOME:-$HOME/.config}/autostart/webcam-tray.desktop"
        echo "  Logs:     journalctl --user -u $SERVICE_NAME"
        echo "  Logs Tray:journalctl -t $LOG_TAG"
        ;;
    *)
        echo "Comando desconocido: $1"
        echo "Usa '$0 --help' para ver comandos disponibles"
        exit 1
        ;;
esac
